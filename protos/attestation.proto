syntax = "proto3";
package snpguard;

// Attestation Service - used by guest VMs
service AttestationService {
  // Request a random 64-byte nonce for attestation report generation
  rpc GetNonce (NonceRequest) returns (NonceResponse);
  
  // Verify an attestation report and return secret if successful
  rpc VerifyReport (AttestationRequest) returns (AttestationResponse);
}

// Management Service - used by management tools (future CLI tool, web UI calls gRPC internally)
service ManagementService {
  // List all attestation records
  rpc ListRecords (ListRecordsRequest) returns (ListRecordsResponse);
  
  // Get a single attestation record
  rpc GetRecord (GetRecordRequest) returns (GetRecordResponse);
  
  // Create a new attestation record
  rpc CreateRecord (CreateRecordRequest) returns (CreateRecordResponse);
  
  // Update an attestation record
  rpc UpdateRecord (UpdateRecordRequest) returns (UpdateRecordResponse);
  
  // Delete an attestation record
  rpc DeleteRecord (DeleteRecordRequest) returns (DeleteRecordResponse);
  
  // Toggle enabled/disabled status
  rpc ToggleEnabled (ToggleEnabledRequest) returns (ToggleEnabledResponse);
}

// Attestation messages
message NonceRequest {
  string vm_id = 1;
}

message NonceResponse {
  bytes nonce = 1;  // Exactly 64 bytes
}

message AttestationRequest {
  bytes report_data = 1;
  string cpu_family_hint = 2;  // Optional: "genoa", "milan", "turin"
}

message AttestationResponse {
  bool success = 1;
  bytes secret = 2;
  string error_message = 3;
}

// Management messages
message ListRecordsRequest {
  // Empty - lists all records
}

message ListRecordsResponse {
  repeated AttestationRecord records = 1;
}

message GetRecordRequest {
  string id = 1;
}

message GetRecordResponse {
  optional AttestationRecord record = 1;
}

message CreateRecordRequest {
  string os_name = 1;
  bytes id_key = 2;          // PEM-encoded private key
  bytes auth_key = 3;        // PEM-encoded private key
  bytes firmware = 4;        // Firmware binary
  bytes kernel = 5;          // Kernel binary
  bytes initrd = 6;          // Initrd binary
  string kernel_params = 7;  // Kernel parameters (without rd.attest.url)
  string service_url = 8;    // Attestation service URL
  string secret = 9;         // Secret to release
  uint32 vcpus = 10;
  string vcpu_type = 11;     // EPYC, EPYC-Milan, EPYC-Rome, EPYC-Genoa
}

message CreateRecordResponse {
  string id = 1;
  optional string error_message = 2;
}

message UpdateRecordRequest {
  string id = 1;
  optional string os_name = 2;
  optional bytes id_key = 3;          // PEM-encoded private key (optional update)
  optional bytes auth_key = 4;        // PEM-encoded private key (optional update)
  optional bytes firmware = 5;        // Firmware binary (optional update)
  optional bytes kernel = 6;          // Kernel binary (optional update)
  optional bytes initrd = 7;          // Initrd binary (optional update)
  optional string kernel_params = 8;  // Kernel parameters (optional update)
  optional string service_url = 9;    // Attestation service URL (optional update)
  optional string secret = 10;        // Secret (optional update)
  optional uint32 vcpus = 11;
  optional string vcpu_type = 12;
  optional bool enabled = 13;
}

message UpdateRecordResponse {
  bool success = 1;
  optional string error_message = 2;
}

message DeleteRecordRequest {
  string id = 1;
}

message DeleteRecordResponse {
  bool success = 1;
  optional string error_message = 2;
}

message ToggleEnabledRequest {
  string id = 1;
}

message ToggleEnabledResponse {
  bool enabled = 1;
  optional string error_message = 2;
}

message AttestationRecord {
  string id = 1;
  string os_name = 2;
  int32 request_count = 3;
  string secret = 4;
  string vcpu_type = 5;
  bool enabled = 6;
  string created_at = 7;
  string kernel_params = 8;  // Includes rd.attest.url
  string firmware_path = 9;
  string kernel_path = 10;
  string initrd_path = 11;
  int64 image_id = 12;       // Image ID for attestation report matching
}
