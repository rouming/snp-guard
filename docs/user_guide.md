# SnpGuard User Guide

## Quick Start

### 1. Build the Project

```bash
# Build everything (server, client, snpguest)
make build

# Or build separately
make build-server
make build-client
make build-snpguest
```

### 2. Generate Unsealing Keypair (Offline)

Before creating an attestation record, generate the unsealing keypair:

```bash
# Generate X25519 keypair
snpguard-client keygen --priv-out unsealing.key --pub-out unsealing.pub
```

This creates:
- `unsealing.key`: Private key (keep secure, upload to server during record creation)
- `unsealing.pub`: Public key (use offline to seal VMKs)

**Note**: Keys generated by `snpguard-client keygen` use a non-standard PEM format (raw 32-byte keys wrapped in PEM). This is NOT standard PKCS#8 format. Standard tools like `openssl` may not recognize this format, but it works correctly with SnpGuard.

You can test the keypair by sealing and unsealing a test file:

```bash
# Create test data
echo "test data" > test.txt

# Seal with public key
snpguard-client seal --pub-key unsealing.pub --data test.txt --out test.sealed

# Unseal with private key
snpguard-client unseal --priv-key unsealing.key --sealed-data test.sealed --out test.decrypted

# Verify
cmp test.txt test.decrypted && echo "Keys work correctly!"
```

### 2. Initialize Database

```bash
make db-setup
```

This creates the SQLite database at `data/db/snpguard.sqlite`.

### 3. Start the Server

```bash
export DATA_DIR="$(pwd)/data"
make run-server
```

### 5. Access Management UI

Open your browser and navigate to:
```
https://localhost:3000
```

Log in with the master password that was printed once on first start (no username).

## Creating an Attestation Record

### Step 1: Generate Unsealing Keypair

Generate the X25519 unsealing keypair that will be used to encrypt/decrypt secrets:

```bash
# Using snpguard-client (recommended)
snpguard-client keygen --priv-out unsealing.key --pub-out unsealing.pub
```

**Note**: The unsealing keypair uses X25519 (not EC secp384r1) and is compatible with HPKE encryption used by the attestation service. The private key will be encrypted with the server's ingestion public key before storage.

**Important**: Keep this key secure! It will be encrypted with the ingestion public key (HPKE) and stored by the service.

**Key Format**: Keys generated by `snpguard-client keygen` use a non-standard PEM format (raw 32-byte keys wrapped in PEM). This is NOT standard PKCS#8 format. Standard tools like `openssl` may not recognize this format, but it works correctly with SnpGuard.

**Note**: ID Block Key and Auth Block Key are now automatically generated by the server - you no longer need to provide them.

### Step 2: Prepare Boot Artifacts

You'll need:
- **Firmware**: OVMF firmware binary (usually `OVMF_CODE.fd` or `AmdSev-OVMF.fd`)
- **Kernel**: Linux kernel binary (e.g., `vmlinuz-6.8.0-55-generic`)
- **Initrd**: Initial ramdisk image (e.g., `initrd.img-6.8.0-55-generic`)

### Step 3: Fill the Form

1. Click **"Create New Record"** in the management UI
2. Fill in the form:
   - **OS Name**: A descriptive name (e.g., "Ubuntu 22.04 Production")
   - **Unsealing Private Key**: Paste the PEM-encoded private key (from `unsealing.key`, generated with `snpguard-client keygen`)
   - **Firmware**: Upload the firmware `.fd` file
   - **Kernel**: Upload the kernel binary
   - **Initrd**: Upload the initrd image
   - **Kernel Parameters**: Base kernel parameters (e.g., `console=ttyS0 root=UUID=...`)
   - **vCPUs**: Number of virtual CPUs (e.g., `4`)
   - **vCPU Type**: Select your EPYC variant (EPYC, EPYC-Milan, EPYC-Rome, EPYC-Genoa)

3. Click **"Generate & Save"**

The service will:
- Generate ID Block Key and Auth Block Key automatically
- Generate measurements using `snpguest`
- Create ID-Block and Auth-Block
- Encrypt the unsealing private key with the ingestion public key (HPKE)
- Compute key digests
- Store the record

### Step 4: Download Artifacts

After creation, you can download:
- **ID-Block** and **Auth-Block** binaries
- **Tarball** (`artifacts.tar.gz`) with all files
- **SquashFS** (`artifacts.squashfs`) image

These artifacts need to be provided to your VM boot process.

## Preparing the Guest VM

### Step 1: Repack Initrd

The initrd needs to include the `snpguard-client` binary and the attestation hook. The repack script automatically detects the initrd format and installs the appropriate hook.

```bash
make repack INITRD_IN=/path/to/original-initrd.img INITRD_OUT=/path/to/new-initrd.img
```

Or manually:

```bash
./scripts/repack-initrd.sh /path/to/original-initrd.img /path/to/new-initrd.img
```

**Supported Initrd Formats**:

1. **initramfs-tools** (Ubuntu, Debian):
   - Automatically detected by presence of `scripts/` directory
   - Hook installed at: `scripts/local-top/snpguard_attest`
   - Runs in `local-top` phase: after network setup, before root mounting
   - Compatible with: Ubuntu, Debian, and derivatives

2. **dracut** (RedHat, CentOS, Fedora, etc.):
   - Automatically detected by presence of `lib/dracut/hooks` or `usr/lib/dracut/hooks`
   - Hook installed at: `lib/dracut/hooks/pre-mount/99-snpguard.sh`
   - Runs in `pre-mount` phase: before root filesystem mounting
   - Compatible with: RedHat Enterprise Linux, CentOS, Fedora, Rocky Linux, AlmaLinux

The script will detect which format is being used and install the appropriate hook. If both formats are detected (rare), both hooks will be installed for maximum compatibility.

**Prerequisites**:
- The client binary must be built: `make build-client`
- SEV-SNP must be enabled in the guest firmware and hardware
- The original initrd image must be in cpio+gzip format (standard for both systems)

### Step 2: Boot the VM

Boot the VM. The attestation will happen automatically during the initrd phase, after network initialization but before root filesystem mounting.

## Managing Attestation Records

### Viewing Records

The main page shows all attestation records with:
- **Status**: Active (green) or Disabled (gray)
- **OS Name**: Click to view details
- **Requests**: Number of successful attestations
- **Actions**: View or Delete

### Viewing Record Details

Click on an OS name to view the record details. The view page displays:
- **Basic Information**: OS name, disk secret
- **Boot Configuration**: vCPUs, vCPU type, kernel parameters, service URL
- **Policy Flags**: Debug mode, migration, SMT settings
- **Minimum TCB Versions**: Bootloader, TEE, SNP, microcode requirements
- **Boot Artifacts**: Download links for firmware, kernel, initrd
- **Key Blocks & Packages**: Download links for ID-Block, Auth-Block, tarball, SquashFS

**Note**: Attestation records are **immutable**. To make changes, delete the old record and create a new one with updated values.

### Enabling/Disabling Records

You can temporarily disable an attestation record:
- Click the **"Disable"** button on the record view page

Disabled records will cause attestation requests to fail, but the record remains in the database. You can re-enable it later using the **"Enable"** button.

### Deleting Records

Click **"Delete"** on the main page or record view page. This permanently removes the record and all associated artifacts.

## Using the Client

Subcommands:

- `config login --url <URL> --token <TOKEN> --ca-cert <PATH>`: validates the token via `/v1/health`, then stores URL/token and copies CA to `~/.config/snpguard/`. `config logout` removes them.
- `attest --report <REPORT_PATH> --url <URL> --ca-cert <PATH>`: submit a pre-generated report over HTTPS+protobuf with pinned CA (no system trust).
- `manage list|show|create|enable|disable|delete|export`: management calls using stored config by default. `manage show` prints kernel params and artifact filenames; `--json` is available for list/show.
- `manage create`: accepts `--artifacts-bundle` or individual `--firmware/--kernel/--initrd/--kernel-params` plus `--unsealing-private-key` (required). ID and auth keys are generated automatically by the server.

**Example (management export)**:
```bash
snpguard-client manage export --id <record-id> --format tar --out artifacts.tar.gz   # format: tar|squashfs
```

## Troubleshooting

### Client Connection Issues

**Problem**: Client fails to connect to server

**Solutions**:
- Verify the URL is correct and uses HTTPS
- Check network connectivity from the guest VM
- Ensure TLS certificate is valid
- Check server logs for errors

### Attestation Fails

**Problem**: Attestation verification fails

**Solutions**:
1. **Check Nonce Validity**: 
   - Ensure the nonce was received from the server (not reused or expired)
   - Nonce must be within +/- 60 seconds of generation
   - Check server logs for nonce verification errors
2. **Check Binding Hash**: 
   - Ensure the binding hash (SHA512(server_nonce || client_pub_bytes)) matches the report_data field
   - Verify the client is using the correct server_nonce and client_pub_bytes
3. **Check Record Status**: Ensure the attestation record is enabled
4. **Verify Key Digests**: The ID-Block and Auth-Block key digests must match those stored in the record (keys are generated by the server)
5. **Check CPU Family**: Ensure the vCPU type matches your actual CPU
6. **Review Server Logs**: Check for detailed error messages
7. **Verify Report**: Ensure `snpguest` is generating valid reports

### Report Verification Fails

**Problem**: Server cannot verify the attestation report

**Solutions**:
- The server uses the integrated `snpguest` binary built from the submodule
- Check network connectivity to AMD KDS (for certificate fetching)
- Verify the attestation report is not corrupted
- Check that the CPU family detection is correct
- Ensure the snpguest binary was built successfully: `make build-snpguest`

### File Upload Issues

**Problem**: File upload fails or is rejected

**Solutions**:
- Check file size limits:
  - Firmware: <10 MB
  - Kernel: <50 MB
  - Initrd: <50 MB
- Ensure files are in the correct format
- Check server disk space

### Initrd Repacking Issues

**Problem**: Repacked initrd doesn't work

**Solutions**:
- Ensure `snpguest` is available in the initrd
- Verify the client binary is built for the correct architecture
- Check that the initrd format is supported:
  - **initramfs-tools**: Look for `scripts/` directory in unpacked initrd
  - **dracut**: Look for `lib/dracut/hooks` or `usr/lib/dracut/hooks` directory
- Verify the hook was installed:
  - **initramfs-tools**: Check for `scripts/local-top/snpguard_attest`
  - **dracut**: Check for `lib/dracut/hooks/pre-mount/99-snpguard.sh`
- Ensure the hook has execute permissions
- Test the repacked initrd in a VM before production use
- Check boot logs for hook execution messages

## Best Practices

### Security

1. **Use Strong Passwords**: Set strong credentials for the management UI
2. **Enable TLS**: Always use HTTPS in production
3. **Secure Key Storage**: 
   - Unsealing private keys are encrypted at rest using HPKE (Hybrid Public Key Encryption)
   - The ingestion private key (`/data/auth/ingestion.key`) must be backed up securely
   - ID-Block and Auth-Block keys are generated by the server and not stored after use
   - **Key Format**: All X25519 keys (unsealing and ingestion) use a non-standard PEM format (raw 32-byte keys wrapped in PEM). This is NOT standard PKCS#8 format. Standard tools like `openssl` may not recognize this format, but it works correctly with SnpGuard.
4. **Network Security**: Restrict access to the attestation service
5. **Regular Updates**: Keep the server and dependencies updated

### Key Management

1. **Backup Ingestion Private Key**: Keep secure backups of `/data/auth/ingestion.key` - if lost, encrypted unsealing keys cannot be recovered
2. **Key Rotation**: Consider rotating unsealing private keys periodically by creating new records
3. **Separate Keys**: Use different keys for different environments (dev, staging, prod)

### Monitoring

1. **Request Counts**: Monitor the request count to detect unusual activity
2. **Failed Attestations**: Set up alerts for failed attestation attempts
3. **Server Logs**: Regularly review server logs for errors

### Performance

1. **Certificate Caching**: Consider caching AMD certificates to reduce latency
2. **Database Optimization**: For large deployments, consider PostgreSQL
3. **Artifact Storage**: For distributed deployments, use shared storage

## Advanced Usage

### Custom Initrd Hooks

You can customize the initrd hook script to integrate with your specific boot process. The hook is installed at:
- `scripts/local-top/snpguard_attest` (initramfs-tools)
- `lib/dracut/hooks/pre-mount/99-snpguard.sh` (dracut)

### API Integration

You can integrate the attestation API into your own tools. See `docs/api.md` for details.

### Environment Variables

- `DATA_DIR`: Root persistence directory (default: `/data`)
- `RUST_LOG`: Log level (default: `info`)

## Getting Help

- **Documentation**: See `docs/` directory for detailed documentation
- **Issues**: Open an issue on the GitHub repository
- **Logs**: Check server logs for detailed error messages
